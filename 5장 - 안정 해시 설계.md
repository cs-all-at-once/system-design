# 안정 해시 (Consistent Hashing)

수평적 규모 확장성을 달성하기 위해서는  
요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.  
**안정 해시(Consistent Hashing)** 는 이를 위해 널리 사용되는 기술이다.

---

## 해시 키 재배치 문제

해시 기술이 해결하려는 문제를 먼저 살펴보자.

N개의 캐시 서버가 있다고 하자.  
이 서버들에 부하를 균등하게 나누는 보편적 방법은 다음과 같은 해시 함수를 사용하는 것이다.

```
serverIndex = hash(key) % N  // N은 서버의 개수
```

클라이언트는 캐시에 보관된 데이터를 가져오기 위해  
계산된 인덱스에 해당하는 서버에 접속한다.

이 방식은 **서버 수가 고정**되어 있고, **데이터 분포가 균등**할 경우 잘 동작한다.  
하지만 서버가 **추가되거나 삭제되면** 문제가 발생한다.

서버 수가 변경되면 `% N` 결과가 달라져  
**대규모 캐시 미스(cache miss)** 가 발생한다.  
안정 해시는 이 문제를 효과적으로 해결하는 기술이다.

---

## 안정 해시란?

안정 해시(Consistent Hash)는  
해시 테이블 크기가 조정될 때 평균적으로 오직 `k/n`개의 키만 재배치하는 해시 기법이다.

- `k`는 전체 키의 개수  
- `n`은 슬롯(slot, 서버)의 개수

대부분의 전통적 해시 테이블은  
슬롯 수가 바뀌면 **거의 모든 키를 재배치**해야 하는 단점이 있다.

---

## 해시 공간과 해시 함수

예를 들어, SHA-1 해시 함수를 사용한다고 가정하자.  
SHA-1의 해시 공간은 `0`부터 `2^160 - 1`까지다.  
이를 원형으로 접으면 **해시 링(hash ring)** 이 만들어진다.

---

## 해시 서버와 해시 키

- 서버의 IP나 이름을 해시 함수에 넣어 링 상의 위치에 대응시킨다.
- 마찬가지로 캐시할 키들도 해시를 통해 링 위의 위치를 가진다.
- 이때는 `%` 연산을 사용하지 않는다.

---

## 서버 조회 방법

어떤 키가 저장되는 서버는,  
해당 키의 위치로부터 **시계 방향으로 링을 탐색**해  
만나는 **첫 번째 서버**가 된다.

---

## 서버 추가와 제거

서버를 추가하거나 제거할 경우,  
일부 키만 재배치되기 때문에 효율적이다.

- **추가 시**:  
  새 서버의 위치에서 **반시계 방향 첫 서버**까지 사이에 있는 키들만 새 서버로 이동된다.

- **제거 시**:  
  제거된 서버의 위치에서 **시계 방향 다음 서버**로 해당 키들이 재배치된다.

---

## 기본 구현의 두 가지 문제

안정 해시는 MIT에서 제안된 알고리즘으로  
다음 절차에 기반한다.

1. 서버와 키를 균등 분포 해시 함수로 해시 링에 배치  
2. 키의 위치에서 링을 시계 방향으로 탐색해 만나는 최초의 서버에 키 저장

하지만 이 방식에는 다음 두 가지 문제가 있다.

1. 파티션의 크기를 균등하게 유지하기 어렵다.  
   - 인접 서버 사이 해시 공간이 파티션인데,  
     어떤 서버는 작고, 어떤 서버는 큰 파티션을 가질 수 있음.

2. 키가 균등하게 분포되지 않는다.  
   - 일부 서버에 키가 몰리고, 일부는 데이터가 없는 현상이 발생할 수 있음.

---

## 가상 노드(Virtual Node)

이 문제를 해결하기 위한 방법이 **가상 노드(Virtual Node)** 이다.  
가상 노드는 실제 서버를 대표하는 노드로, 하나의 서버는 여러 개의 가상 노드를 가진다.

- 각 가상 노드는 링 위에 배치된다.  
- 키는 시계 방향으로 탐색하여 만나는 최초의 가상 노드에 저장된다.  
- 가상 노드 개수가 많을수록 키의 분포는 균등해진다.  
- 표준편차가 작아져 데이터 분포가 고르게 된다.

단점은 가상 노드 데이터 관리 비용이 증가한다는 것.  
→ 시스템 요구사항에 따라 가상 노드 개수를 **적절히 조절**해야 한다.

---

## 재배치 대상 키 결정 방법

- **서버 추가 시**  
  새 노드의 위치에서 반시계 방향 첫 서버 사이의 키들만 재배치

- **서버 삭제 시**  
  삭제된 노드 위치에서 시계 방향 다음 서버까지의 키들만 재배치

---

## 정리

안정 해시의 핵심 장점은 다음과 같다.

- 서버가 추가/삭제되더라도 **재배치되는 키의 수가 최소화됨**  
- 데이터가 균등하게 분포되어 **수평적 확장성 확보**  
- **핫스팟 키 문제를 줄임** (ex. 특정 샤드에 쏠리는 인기 키)

---

## 실제 활용 사례

안정 해시는 여러 실제 시스템에서 널리 사용되고 있다.

- Amazon DynamoDB의 파티셔닝 컴포넌트  
- Apache Cassandra 클러스터  
- Discord 채팅 시스템  
- Akamai CDN  
- Meglev 네트워크 부하 분산기
